<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>My Spotify Bubble Chart</title>
  <meta name="description" content="Check your Top Spotify Artists and Chart of your Top Genres">
  <meta name="keywords" content="spotify, spotify stats">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="My Spotify Bubble Chart">
  <meta property="og:description" content="Check your Top Spotify Artists and Bubble Chart of your Top Genres">
  <meta property="og:image" content="https://huangdarren1106.github.io/spotify-stats.jpg">
  <meta property="og:url" content="https://huangdarren1106.github.io/spotify-stats">
  <meta property="og:site_name" content="My Spotify Bubbles - Top Artists - Top Genres">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_US">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="My Spotify Bubble Chart">
  <meta name="twitter:description" content="Check your Top Spotify Artists and Bubble Chart of your Top Genres">
  <meta name="twitter:image" content="https://huangdarren1106.github.io/spotify-stats.jpg">
  <meta name="twitter:image:alt" content="My Spotify Bubble Chart">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@6"></script>
  <script defer data-domain="huangdarren1106.github.io" src="https://stats.senty.com.au/js/script.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3723218062742398"
    crossorigin="anonymous"></script>

  <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
  <script>
    window.googletag = window.googletag || {};
    googletag.cmd = googletag.cmd || [];
    googletag.cmd.push(function () {
      if (window.innerWidth >= 1024) {
        googletag.defineSlot('/147246189,22921845643/huangdarren1106.github.io_1000x100_desktop_anchor', [[1000, 100], [970, 90], [728, 90], [990, 90], [970, 50], [960, 90], [950, 90], [980, 90]], 'huangdarren1106_github_io_anchor_ad_responsive').addService(googletag.pubads());
      } else {
        googletag.defineSlot('/147246189,22921845643/huangdarren1106.github.io_320x100_mobile_anchor', [[320, 100], [320, 50], [300, 100], [300, 50]], 'huangdarren1106_github_io_anchor_ad_responsive').addService(googletag.pubads());
      }
      var interstitialSlot = googletag.defineOutOfPageSlot('/147246189,22921845643/huangdarren1106.github.io_interstitial', googletag.enums.OutOfPageFormat.INTERSTITIAL);
      if (interstitialSlot) interstitialSlot.addService(googletag.pubads());

      googletag.pubads().enableSingleRequest();
      googletag.pubads().disableInitialLoad();
      googletag.pubads().collapseEmptyDivs();
      googletag.enableServices();
      googletag.display(interstitialSlot);
    });
  </script>
  <script async src="https://stpd.cloud/saas/6406"></script>

  <style>
    .ads {
      text-align: center;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body x-data="piechart">
  <header class="max-w-3xl mx-auto">
    <div class="flex flex-col sm:flex-row justify-between items-center py-4 px-4 sm:px-0 border-b">
      <a href="/" class="sm:text-2xl font-bold mb-4 sm:mb-0 whitespace-nowrap">Spotify Pie</a>
      <div class="flex justify-center sm:justify-end w-full gap-4 flex-wrap">
        <a href="/" class="">Spotify Pie</a>
        <a href="/playlist-name-generator">Playlist Name Generator</a>
        <a href="/subscribe" class="">Subscribe</a>
      </div>
    </div>
  </header>

  <div class="max-w-3xl mx-auto prose mt-10 mb-16 px-4 sm:px-0">

    <div class="flex justify-center">
      <div class="bg-red-500 rounded-full text-white px-3 shadow">NEW</div>
    </div>

    <h1 class="text-center text-xl">
      <template x-if="profile">
        <span x-text="profile.display_name + '\'s'"></span>
      </template>
      Spotify Bubble Chart
    </h1>

    <div x-show="!token"
      class="text-center w-full border bg-green-50 rounded-lg p-4 border-green-600 mb-4 flex flex-col items-center">
      <p class="text-lg text-green-800 font-semibold mb-2">
        Visit Login page
      </p>
      <img class="w-24 my-4 motion-safe:animate-spin" src="spotify-pie.png" alt="Spotify Pie">
      <a href="/" class="px-6 py-3 bg-green-600 text-white text-xl rounded-full font-bold">Login</a>
    </div>

    <div x-show="token" class="shadow-lg mb-4 border rounded-lg max-w-sm mx-auto bg-neutral-50">
      <div id="bubble-chart" class="p-4">
        <div class="flex justify-center">
          <div id="chart"></div>
        </div>
        <div x-show="top_artists">
          <table class="mt-2 mb-0 max-w-3xl w-full text-gray-700">
            <tbody class="gap-1 flex flex-col">
              <template x-for="(artist, i) in top_artists.items">
                <tr class="my-0 flex border-0 w-full items-center justify-center" x-key="artist.name">
                  <td
                    class="whitespace-nowrap font-bold shrink-0 my-0 py-0 text-left max-w-[200px] sm:max-w-none leading-none flex items-center">
                    <p :style="{fontSize:`${(11 - i)*2 + 8}px`}" x-text="artist.name" class="my-0"></p>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div x-show="token && top_artists" class="flex justify-center mb-4">
      <button class="px-6 py-3 bg-purple-600 text-white text-xl rounded-full font-bold"
        @click="capture">Download</button>
    </div>
    <p x-show="token" class="max-w-sm mx-auto text-center font-semibold">Don't forget to share it!</p>

    <div x-show="token"
      class="max-w-sm mx-auto text-center w-full border bg-purple-50 rounded-lg p-2 border-purple-600 mb-4 flex flex-col items-center">
      <p class="text-lg text-purple-800 font-semibold mb-2">
        Before you go, <br>check out your full Spotify Stats
      </p>
      <img class="w-20 my-4" src="stats.svg" alt="Spotify Pie">
      <a href="/spotify-stats" class="mb-4 px-6 py-3 bg-purple-600 text-white text-xl rounded-full font-bold">See Your
        Full Spotify Stats</a>
    </div>



    <div class="flex flex-col items-center gap-4 prose mb-8 mx-auto max-w-3xl text-sm justify-center px-4 sm:px-0">
      <a href="/">Spotify Pie Chart</a>
      <a href="/spotify-stats">Spotify Stats 2023</a>
      <a href="/spotify-premium-mod-apk">Spotify Premium APK Alternative 2023</a>
      <a href="/trackify">Trackify - Your Spotify Listening Statistics</a>
      <a href="/playlist-name-generator">Playlist Name Generator</a>
      <a href="/subscribe">New Spotify Pie</a>
    </div>


    <div id="huangdarren1106_github_io_anchor_ad_responsive" class="ads">
      <script>
        googletag.cmd.push(function () {
          googletag.display('huangdarren1106_github_io_anchor_ad_responsive');
        });
      </script>
    </div>

    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('piechart', () => ({
          show: false,
          token: null,
          profile: null,
          time_range: 'short_term',
          top_artists: [],
          genresChartData: [],
          capture() {
            html2canvas(document.querySelector("#bubble-chart", {
              backgroundColor: "none",
              useCORS: true,
              logging: true,
              letterRendering: 1,
              allowTaint: false
            })).then(canvas => {
              var link = document.createElement('a');
              link.download = 'spotify-bubble-chart.png';
              link.href = canvas.toDataURL('image/png')
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);

            });

          },
          setActiveTab(tab) {
            // fetch data depends on activeTab
            if (tab === 'top_tracks') {
              this.getTopTracks(this.time_range);
            } else {
              this.getTopArtists(this.time_range);
            }
          },

          async getProfile() {
            fetch('https://api.spotify.com/v1/me', {
              headers: {
                'Authorization': 'Bearer ' + this.token
              }
            }).then(response => {
              if (response.status === 401) {
                throw new Error('token expired');
              } else {
                return response.json();
              }
            }).then(data => {
              this.profile = data;
              console.log(data);
            }).catch(e => {
              console.log(e);
              this.reset()
            });
          },
          getTopArtists(time_range) {
            fetch(`https://api.spotify.com/v1/me/top/artists?limit=10&time_range=${time_range}`, {
              headers: {
                'Authorization': 'Bearer ' + this.token
              }
            })
              .then(response => {
                if (response.status === 401) {
                  throw new Error('token expired');
                } else {
                  return response.json();
                }

              })
              .then(data => {
                this.top_artists = data;

                this.genresChartData = [];
                const genres = {};
                this.top_artists.items.forEach(artist => {
                  artist.genres.forEach(genre => {
                    if (genres[genre]) {
                      genres[genre] += 1;
                    } else {
                      genres[genre] = 1;
                    }
                  })
                });
                Object.keys(genres).forEach(genre => {
                  this.genresChartData.push({
                    name: genre,
                    value: genres[genre]
                  })
                });
                // sort by value
                this.genresChartData.sort((a, b) => b.value - a.value);
                // filter top 10
                this.genresChartData = this.genresChartData.slice(0, 10);

                // sum of top 10 genres
                const sum = this.genresChartData.reduce((a, b) => a + b.value, 0);

                // add percent to each genre
                this.genresChartData.forEach(genre => {
                  genre.percent = Math.round(genre.value / sum * 100);
                });

                let svg = this.createChartSVG(this.genresChartData, 320, 320)
                console.log(svg)
                document.getElementById('chart').innerHTML = svg.outerHTML;


              }).catch(e => {
                console.log(e);
              });
          },
          reset() {
            this.token = null;
            localStorage.removeItem('token');
          },

          createChartSVG(data, width, height) {
            // Create an SVG element using D3
            var svg = d3.create("svg")
              .attr("width", width)
              .attr("height", height)
              .attr("xmlns", "http://www.w3.org/2000/svg")
              .attr("style", "max-width: 100%; height: auto; font: 12px sans-serif;");

            // Define a scale for the font size
            var fontSizeScale = d3.scaleSqrt()
              .domain([d3.min(data, d => d.value), d3.max(data, d => d.value)])
              .range([10, 20]); // Adjust the range based on your preference

            // Define a color scale for text for better contrast
            var textColor = d3.scaleOrdinal(["white", "black"]);
            // Define a color scale
            var color = d3.scaleOrdinal(d3.schemeCategory10);

            // Create a bubble layout with the specified dimensions
            var bubble = d3.pack()
              .size([width, height])
              .padding(1.5);

            var nodes = d3.hierarchy({ children: data })
              .sum(function (d) { return d.value; });

            // Create the nodes for each bubble
            var node = svg.selectAll(".node")
              .data(bubble(nodes).leaves())
              .enter().append("g")
              .attr("class", "node")
              .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; });

            // Create the circles for each node
            node.append("circle")
              .attr("r", function (d) { return d.r; })
              .attr("fill", function (d, i) { return color(i); }); // Assign different colors

            // Add labels to each circle
            node.append("text")
              .attr("dy", ".3em")
              .style("text-anchor", "middle")
              .style("fill", function (d, i) { return textColor(i % 2); }) // Alternate text color for contrast
              .style("font-size", function (d) { return `${fontSizeScale(d.data.value)}px`; })
              .text(function (d) {
                // Adjust text length based on bubble size
                var maxTextLength = d.r / 3;
                var name = d.data.name;
                return name;
              });

            // Return the SVG node
            return svg.node();
          },

          async init() {
            // read token from local storage
            this.token = localStorage.getItem('token');
            console.log(this.token)
            if (this.token) {
              try {
                await this.getTopArtists(this.time_range)
                await this.getProfile()
              } catch (e) {
                console.log(e);
              }

            }
          }
        }));
      });
    </script>

</body>

</html>